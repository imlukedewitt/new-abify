<div class="grid h-[calc(100dvh-var(--header-height))] grid-cols-[300px_1fr]">
  <!-- Left Sidebar: Workflow Info + Step List -->
  <div class="bg-base-300 p-4 overflow-auto">
    <%= link_to "← Workflows", workflows_path, class: "link-primary text-sm" %>
    <h1 class="mt-2"><%= @workflow.name %></h1>
    <% if @workflow.handle.present? %>
      <div class="text-sm opacity-70 mt-1">
        <span class="badge badge-sm badge-ghost"><%= @workflow.handle %></span>
      </div>
    <% end %>
    <div class="mt-4 space-y-2 text-sm">
      <div>
        <span class="opacity-70">Connection:</span>
        <span><%= @workflow.connection&.name || "None" %></span>
      </div>
    </div>
    <div class="flex gap-2 mt-4">
      <%= link_to "Edit Workflow", edit_workflow_path(@workflow), class: "btn btn-ghost btn-xs" %>
    </div>
    <div class="divider"></div>
    <!-- Steps List -->
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-lg font-semibold">Steps (<%= @workflow.steps.size %>)</h2>
      <%= link_to new_workflow_step_path(@workflow), class: "btn btn-primary btn-xs" do %>
        + Add Step
      <% end %>
    </div>
    <ul class="space-y-2">
      <% @workflow.steps.each_with_index do |step, index| %>
        <li class="card <%= step.id == @step.id ? "bg-primary text-primary-content" : "bg-base-100" %> shadow-sm">
          <div class="card-body p-3">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="badge badge-ghost badge-sm"><%= index + 1 %></span>
                <%= link_to step.name, workflow_step_path(@workflow, step),
                                            class: "font-medium #{step.id == @step.id ? "" : "hover:text-primary"}" %>
              </div>
              <div class="flex items-center gap-1">
                <% unless index == 0 %>
                  <%= button_to move_up_workflow_step_path(@workflow, step), method: :patch, class: "btn btn-ghost btn-xs", title: "Move up" do %>
                    ↑
                  <% end %>
                <% end %>
                <% unless index == @workflow.steps.size - 1 %>
                  <%= button_to move_down_workflow_step_path(@workflow, step), method: :patch, class: "btn btn-ghost btn-xs", title: "Move down" do %>
                    ↓
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        </li>
      <% end %>
    </ul>
  </div>
  <!-- Right Panel: Step Detail -->
  <div class="bg-base-100 p-6 overflow-auto">
    <div class="flex justify-between items-start mb-4">
      <div>
        <h2 class="text-2xl font-bold"><%= @workflow.steps.index(@step).to_i + 1 %>. <%= @step.name %></h2>
        <% if @step.step_config&.dig("required") %>
          <span class="badge badge-warning mt-1">Required</span>
        <% end %>
      </div>
      <div class="flex gap-2">
        <%= link_to "Edit", edit_workflow_step_path(@workflow, @step), class: "btn btn-primary btn-sm" %>
        <%= button_to workflow_step_path(@workflow, @step),
            method: :delete,
            class: "btn btn-ghost btn-sm text-error",
            title: "Delete step '#{@step.name}'?",
            data: { turbo_confirm: "Delete step '#{@step.name}'?" } do %>
          Delete
        <% end %>
      </div>
    </div>
    <% config = @step.config&.dig("liquid_templates") || {} %>
    <div class="grid grid-cols-2 gap-6">
      <!-- Method & URL -->
      <div class="col-span-2">
        <label class="label"><span class="label-text font-semibold">Request</span></label>
        <div class="flex gap-2 items-center bg-base-200 p-3 rounded-lg">
          <span class="badge badge-neutral"><%= config["method"]&.upcase || "GET" %></span>
          <code class="text-sm flex-1 break-all"><%= config["url"] || "-" %></code>
        </div>
      </div>
      <!-- Connection -->
      <div>
        <label class="label"><span class="label-text font-semibold">Connection</span></label>
        <p><%= @step.connection&.name || @workflow.connection&.name || "None" %>
          <% if @step.connection.nil? && @workflow.connection.present? %>
            <span class="text-xs opacity-70">(from workflow)</span>
          <% end %>
        </p>
      </div>
      <!-- Skip Condition -->
      <div>
        <label class="label"><span class="label-text font-semibold">Skip Condition</span></label>
        <% if config["skip_condition"].present? %>
          <code class="text-sm bg-base-200 p-2 rounded block"><%= config["skip_condition"] %></code>
        <% else %>
          <p class="opacity-70">-</p>
        <% end %>
      </div>
      <!-- Request Body -->
      <div class="col-span-2">
        <label class="label"><span class="label-text font-semibold">Request Body</span></label>
        <% if config["body"].present? %>
          <% body_display = if config["body"].is_a?(Hash)
                           JSON.pretty_generate(config["body"])
                         else
                           begin
                             JSON.pretty_generate(JSON.parse(config["body"]))
                           rescue
                             config["body"]
                           end
                         end %>
          <pre class="bg-base-200 p-3 rounded-lg text-sm overflow-auto max-h-80 whitespace-pre-wrap break-words"><%= body_display %></pre>
        <% else %>
          <p class="opacity-70">-</p>
        <% end %>
      </div>
      <!-- Success Data -->
      <div class="col-span-2">
        <label class="label"><span class="label-text font-semibold">Success Data</span></label>
        <% if config["success_data"].present? %>
          <pre class="bg-base-200 p-3 rounded-lg text-sm overflow-auto"><%= JSON.pretty_generate(config["success_data"]) rescue config["success_data"] %></pre>
        <% else %>
          <p class="opacity-70">-</p>
        <% end %>
      </div>
    </div>
  </div>
</div>
